---
interface Props {
	lang?: 'en' | 'zh';
	onUploadComplete?: string; // Callback function name
}

const { lang = 'en', onUploadComplete } = Astro.props;

const t = {
	en: {
		title: 'Upload Image',
		dragDrop: 'Drag and drop an image here, or click to select',
		uploading: 'Uploading...',
		uploadSuccess: 'Upload successful!',
		uploadError: 'Upload failed',
		maxSize: 'Max file size: 10MB',
		allowedTypes: 'Allowed types: JPEG, PNG, GIF, WebP',
		selectFile: 'Select File',
	},
	zh: {
		title: '上传图片',
		dragDrop: '拖拽图片到此处，或点击选择文件',
		uploading: '上传中...',
		uploadSuccess: '上传成功！',
		uploadError: '上传失败',
		maxSize: '最大文件大小：10MB',
		allowedTypes: '支持格式：JPEG、PNG、GIF、WebP',
		selectFile: '选择文件',
	},
};

const text = t[lang];
---

<div class="image-upload-container max-w-2xl mx-auto p-6">
	<div
		id="dropZone"
		class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center hover:border-blue-500 dark:hover:border-blue-400 transition-colors cursor-pointer"
	>
		<input type="file" id="fileInput" accept="image/*" class="hidden" />

		<div id="uploadPrompt">
			<svg
				class="mx-auto h-12 w-12 text-gray-400"
				stroke="currentColor"
				fill="none"
				viewBox="0 0 48 48"
				aria-hidden="true"
			>
				<path
					d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
					stroke-width="2"
					stroke-linecap="round"
					stroke-linejoin="round"></path>
			</svg>
			<p class="mt-4 text-sm text-gray-600 dark:text-gray-300">
				{text.dragDrop}
			</p>
			<p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
				{text.maxSize}
			</p>
			<p class="text-xs text-gray-500 dark:text-gray-400">
				{text.allowedTypes}
			</p>
			<button
				type="button"
				id="selectButton"
				class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
			>
				{text.selectFile}
			</button>
		</div>

		<div id="uploadProgress" class="hidden">
			<div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
			<p class="mt-4 text-sm text-gray-600 dark:text-gray-300">{text.uploading}</p>
		</div>

		<div id="uploadResult" class="hidden">
			<div id="previewContainer" class="mb-4"></div>
			<p id="resultMessage" class="text-sm"></p>
			<button
				type="button"
				id="uploadAnother"
				class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
			>
				{text.selectFile}
			</button>
		</div>
	</div>

	<div id="uploadedImageUrl" class="hidden mt-4 p-4 bg-gray-100 dark:bg-gray-800 rounded-lg">
		<p class="text-sm font-medium mb-2">Image URL:</p>
		<code id="imageUrlCode" class="block p-2 bg-white dark:bg-gray-900 rounded text-sm break-all"></code>
		<button
			type="button"
			id="copyUrlButton"
			class="mt-2 px-3 py-1 bg-gray-600 text-white text-sm rounded hover:bg-gray-700 transition-colors"
		>
			Copy URL
		</button>
	</div>
</div>

<script define:vars={{ text, onUploadComplete }}>
	const dropZone = document.getElementById('dropZone');
	const fileInput = document.getElementById('fileInput');
	const selectButton = document.getElementById('selectButton');
	const uploadPrompt = document.getElementById('uploadPrompt');
	const uploadProgress = document.getElementById('uploadProgress');
	const uploadResult = document.getElementById('uploadResult');
	const previewContainer = document.getElementById('previewContainer');
	const resultMessage = document.getElementById('resultMessage');
	const uploadAnother = document.getElementById('uploadAnother');
	const uploadedImageUrl = document.getElementById('uploadedImageUrl');
	const imageUrlCode = document.getElementById('imageUrlCode');
	const copyUrlButton = document.getElementById('copyUrlButton');

	let currentImageUrl = '';

	// Click to select file
	selectButton.addEventListener('click', () => {
		fileInput.click();
	});

	dropZone.addEventListener('click', (e) => {
		if (e.target === dropZone || e.target.closest('#uploadPrompt')) {
			fileInput.click();
		}
	});

	uploadAnother.addEventListener('click', () => {
		resetUpload();
		fileInput.click();
	});

	// Drag and drop
	dropZone.addEventListener('dragover', (e) => {
		e.preventDefault();
		dropZone.classList.add('border-blue-500', 'dark:border-blue-400');
	});

	dropZone.addEventListener('dragleave', () => {
		dropZone.classList.remove('border-blue-500', 'dark:border-blue-400');
	});

	dropZone.addEventListener('drop', (e) => {
		e.preventDefault();
		dropZone.classList.remove('border-blue-500', 'dark:border-blue-400');

		const files = e.dataTransfer.files;
		if (files.length > 0) {
			handleFile(files[0]);
		}
	});

	fileInput.addEventListener('change', (e) => {
		const files = e.target.files;
		if (files.length > 0) {
			handleFile(files[0]);
		}
	});

	// Copy URL button
	copyUrlButton.addEventListener('click', async () => {
		try {
			await navigator.clipboard.writeText(currentImageUrl);
			copyUrlButton.textContent = 'Copied!';
			setTimeout(() => {
				copyUrlButton.textContent = 'Copy URL';
			}, 2000);
		} catch (err) {
			console.error('Failed to copy:', err);
		}
	});

	async function handleFile(file) {
		// Validate file type
		const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
		if (!allowedTypes.includes(file.type)) {
			showError(`${text.uploadError}: ${text.allowedTypes}`);
			return;
		}

		// Validate file size (10MB)
		const maxSize = 10 * 1024 * 1024;
		if (file.size > maxSize) {
			showError(`${text.uploadError}: ${text.maxSize}`);
			return;
		}

		// Show progress
		uploadPrompt.classList.add('hidden');
		uploadProgress.classList.remove('hidden');

		// Upload file
		const formData = new FormData();
		formData.append('file', file);

		try {
			const response = await fetch('/api/upload', {
				method: 'POST',
				body: formData,
			});

			const result = await response.json();

			if (result.success) {
				showSuccess(result.data.url);
			} else {
				showError(`${text.uploadError}: ${result.error}`);
			}
		} catch (error) {
			showError(`${text.uploadError}: ${error.message}`);
		}
	}

	function showSuccess(url) {
		uploadProgress.classList.add('hidden');
		uploadResult.classList.remove('hidden');

		// Show preview
		const img = document.createElement('img');
		img.src = url;
		img.className = 'max-w-full h-auto rounded-lg mx-auto';
		img.style.maxHeight = '300px';
		previewContainer.innerHTML = '';
		previewContainer.appendChild(img);

		resultMessage.textContent = text.uploadSuccess;
		resultMessage.className = 'text-sm text-green-600 dark:text-green-400';

		// Show URL
		currentImageUrl = url;
		imageUrlCode.textContent = url;
		uploadedImageUrl.classList.remove('hidden');

		// Call callback if provided
		if (onUploadComplete && typeof window[onUploadComplete] === 'function') {
			window[onUploadComplete](url);
		}
	}

	function showError(message) {
		uploadProgress.classList.add('hidden');
		uploadResult.classList.remove('hidden');

		previewContainer.innerHTML = '';
		resultMessage.textContent = message;
		resultMessage.className = 'text-sm text-red-600 dark:text-red-400';

		uploadedImageUrl.classList.add('hidden');
	}

	function resetUpload() {
		uploadResult.classList.add('hidden');
		uploadPrompt.classList.remove('hidden');
		fileInput.value = '';
		uploadedImageUrl.classList.add('hidden');
		currentImageUrl = '';
	}
</script>
